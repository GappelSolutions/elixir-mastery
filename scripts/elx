#!/usr/bin/env bash
# Elixir Learning CLI - Track progress through topics

set +e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
STATE_FILE="$PROJECT_DIR/.elx-state"
PROGRESS_FILE="$PROJECT_DIR/PROGRESS.md"

SECTIONS=(
  "01-elixir-core"
  "02-otp"
  "03-phoenix"
  "04-ecto"
  "05-liveview"
  "06-channels"
  "07-testing"
  "08-deployment"
  "09-advanced"
  "10-metaprogramming"
)

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

load_state() {
  if [[ -f "$STATE_FILE" ]]; then
    source "$STATE_FILE"
  else
    CURRENT_SECTION="01-elixir-core"
    CURRENT_TOPIC="01-pattern-matching"
    save_state
  fi
  [[ ! -f "$PROGRESS_FILE" ]] && init_progress_file
}

save_state() {
  echo "CURRENT_SECTION=\"$CURRENT_SECTION\"" > "$STATE_FILE"
  echo "CURRENT_TOPIC=\"$CURRENT_TOPIC\"" >> "$STATE_FILE"
}

# Get all topics for a section
get_topics() {
  local section=$1
  local docs_dir="$PROJECT_DIR/$section"
  local ex_dir="$PROJECT_DIR/exercises/$section"
  local all_names=""

  if [[ -d "$docs_dir" ]]; then
    for f in "$docs_dir"/*.md; do
      [[ -e "$f" ]] || continue
      all_names="$all_names $(basename "$f" .md)"
    done
  fi

  if [[ -d "$ex_dir" ]]; then
    for f in "$ex_dir"/*.ex; do
      [[ -e "$f" ]] || continue
      all_names="$all_names $(basename "$f" .ex)"
    done
  fi

  echo "$all_names" | tr ' ' '\n' | grep -v '^$' | sort -u | tr '\n' ' '
}

init_progress_file() {
  cat > "$PROGRESS_FILE" << 'EOF'
# Elixir Mastery Progress

Track your learning journey. Items marked with [x] are complete.

EOF

  for section in "${SECTIONS[@]}"; do
    echo "## $section" >> "$PROGRESS_FILE"
    echo "" >> "$PROGRESS_FILE"

    local topics=$(get_topics "$section")
    for topic in $topics; do
      echo "- [ ] $topic" >> "$PROGRESS_FILE"
    done
    echo "" >> "$PROGRESS_FILE"
  done
}

is_complete() {
  local topic=$1
  grep -q "\[x\] $topic$" "$PROGRESS_FILE" 2>/dev/null
}

mark_complete() {
  local topic=$1
  if [[ "$(uname)" == "Darwin" ]]; then
    sed -i '' "s/- \[ \] $topic$/- [x] $topic/" "$PROGRESS_FILE"
  else
    sed -i "s/- \[ \] $topic$/- [x] $topic/" "$PROGRESS_FILE"
  fi
}

count_progress() {
  local section=$1
  local total=0 done=0

  if [[ ! -f "$PROGRESS_FILE" ]]; then
    printf "0/0"
    return
  fi

  if [[ -z "$section" ]]; then
    total=$(grep -c "^\- \[" "$PROGRESS_FILE" 2>/dev/null) || total=0
    done=$(grep -c "^\- \[x\]" "$PROGRESS_FILE" 2>/dev/null) || done=0
  else
    local content
    content=$(sed -n "/^## $section\$/,/^## /p" "$PROGRESS_FILE" 2>/dev/null)
    total=$(echo "$content" | grep -c "^\- \[" 2>/dev/null) || total=0
    done=$(echo "$content" | grep -c "^\- \[x\]" 2>/dev/null) || done=0
  fi

  printf "%d/%d" "$done" "$total"
}

has_doc() {
  [[ -f "$PROJECT_DIR/$CURRENT_SECTION/$1.md" ]]
}

has_exercise() {
  [[ -f "$PROJECT_DIR/exercises/$CURRENT_SECTION/$1.ex" ]]
}

show_status() {
  clear
  echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${BOLD}${CYAN}â•‘       ELIXIR MASTERY - Learning Tracker       â•‘${NC}"
  echo -e "${BOLD}${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""

  local progress=$(count_progress)
  local section_progress=$(count_progress "$CURRENT_SECTION")
  echo -e "${BOLD}Overall:${NC} ${GREEN}$progress${NC} complete"
  echo ""
  echo -e "${BOLD}Section:${NC} ${YELLOW}$CURRENT_SECTION${NC} ($section_progress)"
  echo -e "${BOLD}Topic:${NC}   ${YELLOW}$CURRENT_TOPIC${NC}"

  # Show what's available
  local avail=""
  has_doc "$CURRENT_TOPIC" && avail="ðŸ“– doc"
  has_exercise "$CURRENT_TOPIC" && avail="$avail ðŸ’» exercise"
  echo -e "         ${DIM}$avail${NC}"

  # Completion status
  if is_complete "$CURRENT_TOPIC"; then
    echo -e "         ${GREEN}âœ“ Completed${NC}"
  else
    echo -e "         ${DIM}â—‹ In progress${NC}"
    # Show exercise TODOs
    local ex_file="$PROJECT_DIR/exercises/$CURRENT_SECTION/$CURRENT_TOPIC.ex"
    if [[ -f "$ex_file" ]]; then
      local todos=$(grep -c ":todo" "$ex_file" 2>/dev/null) || todos=0
      [[ $todos -gt 0 ]] && echo -e "         ${YELLOW}$todos exercises remaining${NC}"
    fi
  fi

  echo ""
  echo -e "${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

show_menu() {
  echo ""
  echo -e "${BOLD}Navigate${NC}            ${BOLD}Actions${NC}"
  echo -e "  ${CYAN}n${NC} Next            ${CYAN}d${NC} Open doc"
  echo -e "  ${CYAN}p${NC} Previous        ${CYAN}e${NC} Open exercise"
  echo -e "  ${CYAN}j${NC} Jump            ${CYAN}t${NC} Run tests"
  echo -e "  ${CYAN}l${NC} List all        ${CYAN}f${NC} Get feedback"
  echo -e "                    ${CYAN}s${NC} View solution"
  echo -e "${BOLD}Progress${NC}"
  echo -e "  ${CYAN}x${NC} Mark complete   ${CYAN}c${NC} Commit"
  echo -e "  ${CYAN}q${NC} Quit"
  echo ""
  echo -ne "${BOLD}> ${NC}"
}

open_doc() {
  local doc="$PROJECT_DIR/$CURRENT_SECTION/$CURRENT_TOPIC.md"
  [[ -f "$doc" ]] && nvim "$doc" || echo -e "${YELLOW}No doc for this topic${NC}"
}

open_exercise() {
  local ex="$PROJECT_DIR/exercises/$CURRENT_SECTION/$CURRENT_TOPIC.ex"
  [[ -f "$ex" ]] && nvim "$ex" || echo -e "${YELLOW}No exercise for this topic${NC}"
}

run_tests() {
  local ex="$PROJECT_DIR/exercises/$CURRENT_SECTION/$CURRENT_TOPIC.ex"
  if [[ -f "$ex" ]]; then
    echo -e "${CYAN}Running tests...${NC}"
    echo ""
    elixir "$ex"
  else
    echo -e "${YELLOW}No exercise file${NC}"
  fi
  echo ""
  read -n1 -s -p "Press any key..."
}

get_feedback() {
  local ex="$PROJECT_DIR/exercises/$CURRENT_SECTION/$CURRENT_TOPIC.ex"
  if [[ -f "$ex" ]]; then
    echo -e "${CYAN}Run in agent tab:${NC}"
    echo -e "${YELLOW}/elixir-review $ex${NC}"
    echo "$ex" | pbcopy 2>/dev/null || true
    echo -e "${GREEN}Path copied${NC}"
  else
    echo -e "${YELLOW}No exercise file${NC}"
  fi
  read -n1 -s -p "Press any key..."
}

view_solution() {
  local sol="$PROJECT_DIR/exercises/solutions/$CURRENT_TOPIC.ex"
  if [[ -f "$sol" ]]; then
    echo -e "${YELLOW}View solution? (y/N)${NC}"
    read -n1 confirm
    echo ""
    [[ "$confirm" =~ ^[Yy]$ ]] && nvim -R "$sol"
  else
    echo -e "${YELLOW}No solution available${NC}"
    sleep 1
  fi
}

navigate() {
  local direction=$1
  local topics=$(get_topics "$CURRENT_SECTION")
  local topics_arr=($topics)
  local num=${#topics_arr[@]}
  local idx=0

  for i in "${!topics_arr[@]}"; do
    [[ "${topics_arr[$i]}" == "$CURRENT_TOPIC" ]] && idx=$i && break
  done

  local new_idx
  [[ "$direction" == "next" ]] && new_idx=$((idx + 1)) || new_idx=$((idx - 1))

  if [[ $new_idx -ge 0 && $new_idx -lt $num ]]; then
    CURRENT_TOPIC="${topics_arr[$new_idx]}"
    save_state
  elif [[ "$direction" == "next" && $new_idx -ge $num ]]; then
    next_section
  elif [[ "$direction" == "prev" && $new_idx -lt 0 ]]; then
    prev_section
  fi
}

next_section() {
  local idx=0
  for i in "${!SECTIONS[@]}"; do
    [[ "${SECTIONS[$i]}" == "$CURRENT_SECTION" ]] && idx=$i && break
  done

  local next=$((idx + 1))
  if [[ $next -lt ${#SECTIONS[@]} ]]; then
    CURRENT_SECTION="${SECTIONS[$next]}"
    local topics=$(get_topics "$CURRENT_SECTION")
    local arr=($topics)
    [[ ${#arr[@]} -gt 0 ]] && CURRENT_TOPIC="${arr[0]}"
    save_state
  fi
}

prev_section() {
  local idx=0
  for i in "${!SECTIONS[@]}"; do
    [[ "${SECTIONS[$i]}" == "$CURRENT_SECTION" ]] && idx=$i && break
  done

  local prev=$((idx - 1))
  if [[ $prev -ge 0 ]]; then
    CURRENT_SECTION="${SECTIONS[$prev]}"
    local topics=$(get_topics "$CURRENT_SECTION")
    local arr=($topics)
    local last=$((${#arr[@]} - 1))
    [[ $last -ge 0 ]] && CURRENT_TOPIC="${arr[$last]}"
    save_state
  fi
}

jump_section() {
  echo ""
  echo -e "${BOLD}Sections:${NC}"
  for i in "${!SECTIONS[@]}"; do
    local mark=" "
    [[ "${SECTIONS[$i]}" == "$CURRENT_SECTION" ]] && mark=">"
    local prog=$(count_progress "${SECTIONS[$i]}")
    echo -e "  ${CYAN}$((i+1))${NC} $mark ${SECTIONS[$i]} ${DIM}($prog)${NC}"
  done
  echo ""
  read -p "Section (1-${#SECTIONS[@]}): " choice

  if [[ "$choice" =~ ^[0-9]+$ ]] && [[ $choice -ge 1 ]] && [[ $choice -le ${#SECTIONS[@]} ]]; then
    CURRENT_SECTION="${SECTIONS[$((choice-1))]}"
    local topics=$(get_topics "$CURRENT_SECTION")
    local arr=($topics)

    echo ""
    echo -e "${BOLD}Topics:${NC}"
    for i in "${!arr[@]}"; do
      local status="â—‹"
      is_complete "${arr[$i]}" && status="${GREEN}âœ“${NC}"
      echo -e "  ${CYAN}$((i+1))${NC} $status ${arr[$i]}"
    done
    echo ""
    read -p "Topic (1-${#arr[@]}): " tchoice

    if [[ "$tchoice" =~ ^[0-9]+$ ]] && [[ $tchoice -ge 1 ]] && [[ $tchoice -le ${#arr[@]} ]]; then
      CURRENT_TOPIC="${arr[$((tchoice-1))]}"
    fi
    save_state
  fi
}

list_all() {
  echo ""
  for section in "${SECTIONS[@]}"; do
    local prog=$(count_progress "$section")
    local mark=" "
    [[ "$section" == "$CURRENT_SECTION" ]] && mark="${CYAN}>${NC}"
    echo -e "$mark ${BOLD}$section${NC} ${DIM}($prog)${NC}"

    local topics=$(get_topics "$section")
    for topic in $topics; do
      local status="â—‹"
      is_complete "$topic" && status="${GREEN}âœ“${NC}"
      local cur=""
      [[ "$section" == "$CURRENT_SECTION" && "$topic" == "$CURRENT_TOPIC" ]] && cur=" ${YELLOW}â—€${NC}"
      echo -e "    $status $topic$cur"
    done
  done
  echo ""
  read -n1 -s -p "Press any key..."
}

commit_progress() {
  cd "$PROJECT_DIR"
  if git diff --quiet && git diff --cached --quiet; then
    echo -e "${YELLOW}No changes${NC}"
    read -n1 -s
    return
  fi

  git add -A
  local msg="progress: $CURRENT_SECTION/$CURRENT_TOPIC"
  local prog=$(count_progress "$CURRENT_SECTION")
  local done="${prog%/*}"
  local total="${prog#*/}"
  [[ "$done" == "$total" ]] && msg="complete: $CURRENT_SECTION"

  git commit -m "$msg

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
  echo -e "${GREEN}âœ“ $msg${NC}"
  read -n1 -s -p "Press any key..."
}

main() {
  load_state
  while true; do
    show_status
    show_menu
    read -n1 cmd
    echo ""
    case $cmd in
      d) open_doc ;;
      e) open_exercise ;;
      t) run_tests ;;
      f) get_feedback ;;
      s) view_solution ;;
      x) mark_complete "$CURRENT_TOPIC"; echo -e "${GREEN}âœ“ Done${NC}"; sleep 0.5 ;;
      c) commit_progress ;;
      n) navigate next ;;
      p) navigate prev ;;
      j) jump_section ;;
      l) list_all ;;
      q) echo "Happy learning!"; exit 0 ;;
    esac
  done
}

main
